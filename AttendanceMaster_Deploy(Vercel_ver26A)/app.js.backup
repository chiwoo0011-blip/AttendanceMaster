const DB_KEY = 'attendance_data';
const WORKERS_KEY = 'worker_list';

// --- 실제 배포된 인터넷 주소를 여기에 적으세요 (예: https://my-app.github.io) ---
// 이 주소가 없으면 직원들이 링크를 눌러도 접속할 수 없습니다.
const GLOBAL_URL = "https://jade-pavlova-0cac6f.netlify.app";

// --- 서버 설정 (Firebase 연동용) ---
// 실제 사용 시 Firebase 설정을 여기에 붙여넣으세요.
// (설정 방법은 잠시 후 안내해 드리겠습니다.)
const SERVER_CONFIG = {
    useServer: true, // true로 바꾸면 서버와 연동됩니다.
    databaseURL: "https://yrs-workingdaycheck-default-rtdb.firebaseio.com/"
};

const AttendanceDB = {
    getAll: () => {
        try {
            const data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            return Array.isArray(data) ? data : Object.values(data);
        } catch (e) { return []; }
    },
    getWorkers: () => {
        try {
            const data = JSON.parse(localStorage.getItem(WORKERS_KEY) || '[]');
            return Array.isArray(data) ? data : Object.values(data);
        } catch (e) { return []; }
    },

    saveWorker: async (worker) => {
        const workers = AttendanceDB.getWorkers();
        workers.push({ ...worker, id: Date.now() + Math.random() });
        localStorage.setItem(WORKERS_KEY, JSON.stringify(workers));

        if (SERVER_CONFIG.useServer) {
            await fetch(`${SERVER_CONFIG.databaseURL}/workers.json`, {
                method: 'PUT',
                body: JSON.stringify(workers)
            });
        }
    },

    updateWorker: async (worker) => {
        const workers = AttendanceDB.getWorkers();
        // ID 비교를 위해 둘 다 Number로 변환
        const targetId = Number(worker.id);
        const index = workers.findIndex(w => Number(w.id) === targetId);

        if (index !== -1) {
            // 저장할 때도 ID는 숫자로 유지
            workers[index] = { ...workers[index], ...worker, id: targetId };
            localStorage.setItem(WORKERS_KEY, JSON.stringify(workers));

            if (SERVER_CONFIG.useServer) {
                await fetch(`${SERVER_CONFIG.databaseURL}/workers.json`, {
                    method: 'PUT',
                    body: JSON.stringify(workers)
                });
            }
        }
    },

    getWorkerByName: (name) => {
        return AttendanceDB.getWorkers().find(w => w.name === name);
    },

    deleteWorker: async (id) => {
        const workers = AttendanceDB.getWorkers();
        const targetId = Number(id);
        const filtered = workers.filter(w => Number(w.id) !== targetId);
        localStorage.setItem(WORKERS_KEY, JSON.stringify(filtered));

        if (SERVER_CONFIG.useServer) {
            await fetch(`${SERVER_CONFIG.databaseURL}/workers.json`, {
                method: 'PUT',
                body: JSON.stringify(filtered)
            });
        }
    },

    // 명단 서버 동기화 (새 PC로 이사 왔을 때 사용)
    syncWorkersWithServer: async () => {
        if (!SERVER_CONFIG.useServer) return;
        try {
            const res = await fetch(`${SERVER_CONFIG.databaseURL}/workers.json`);
            const serverWorkers = await res.json();
            if (serverWorkers) {
                const workersArr = Array.isArray(serverWorkers) ? serverWorkers : Object.values(serverWorkers);
                localStorage.setItem(WORKERS_KEY, JSON.stringify(workersArr));
                return workersArr.length;
            }
        } catch (e) {
            console.error('명단 동기화 실패', e);
        }
        return 0;
    },

    // [검증 함수] 이미 제출했는지, 등록된 사람인지 확인
    validateSubmission: async (name, month) => {
        if (!SERVER_CONFIG.useServer) return { valid: true }; // 서버 없으면 패스

        try {
            // 1. 등록된 인원인지 확인
            const wRes = await fetch(`${SERVER_CONFIG.databaseURL}/workers.json`);
            const serverData = await wRes.json() || [];
            const workers = Array.isArray(serverData) ? serverData : Object.values(serverData);

            // 등록된 이름이 하나라도 있으면 체크 시작 (아직 명단이 없으면 모두 허용)
            if (workers.length > 0) {
                const isRegistered = workers.some(w => w.name === name);
                if (!isRegistered) {
                    return { valid: false, message: `'${name}'님은 등록된 직원이 아닙니다.\n관리자에게 문의해주세요.` };
                }
            }

            // 2. 이미 제출했는지 확인 (중복 체크)
            const rRes = await fetch(`${SERVER_CONFIG.databaseURL}/records.json`);
            const recordsMap = await rRes.json() || {};
            const records = Object.values(recordsMap);

            // 해당 이름으로, 해당 월(YYYY-MM)에 시작하는 데이터가 있는지 확인
            const isDuplicate = records.some(r => r.name === name && r.date.startsWith(month));

            if (isDuplicate) {
                return { valid: false, message: `이미 ${month}월 출근부를 제출하셨습니다.\n수정이 필요하면 관리자에게 요청하세요.` };
            }

            return { valid: true };

        } catch (e) {
            console.error(e);
            return { valid: true }; // 에러 나면 일단 허용 (네트워크 문제 등)
        }
    },

    save: async (data) => {
        const current = AttendanceDB.getAll();
        current.push(data);
        localStorage.setItem(DB_KEY, JSON.stringify(current));

        if (SERVER_CONFIG.useServer && SERVER_CONFIG.databaseURL) {
            await fetch(`${SERVER_CONFIG.databaseURL}/records.json`, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        }
    },

    saveBulk: async (newDataArray, skipServer = false) => {
        const current = AttendanceDB.getAll();
        const updated = [...current, ...newDataArray];
        localStorage.setItem(DB_KEY, JSON.stringify(updated));

        if (!skipServer && SERVER_CONFIG.useServer && SERVER_CONFIG.databaseURL) {
            for (const data of newDataArray) {
                await fetch(`${SERVER_CONFIG.databaseURL}/records.json`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
        }
    },

    // 서버에서 데이터를 긁어와서 내 컴퓨터와 합치는 기능
    syncWithServer: async () => {
        if (!SERVER_CONFIG.useServer || !SERVER_CONFIG.databaseURL) return { success: false, count: 0 };

        try {
            const response = await fetch(`${SERVER_CONFIG.databaseURL}/records.json`);
            const serverData = await response.json();
            if (!serverData) return { success: true, count: 0 };

            const current = AttendanceDB.getAll();
            const currentIds = new Set(current.map(r => r.id));

            const newRecords = [];
            Object.values(serverData).forEach(record => {
                if (!currentIds.has(record.id)) {
                    newRecords.push(record);
                }
            });

            if (newRecords.length > 0) {
                await AttendanceDB.saveBulk(newRecords, true);
            }
            return { success: true, count: newRecords.length };
        } catch (e) {
            console.error('서버 동기화 실패:', e);
            return { success: false, count: 0 };
        }
    },

    clear: async () => {
        localStorage.removeItem(DB_KEY);
        if (SERVER_CONFIG.useServer) {
            try {
                await fetch(`${SERVER_CONFIG.databaseURL}/records.json`, { method: 'DELETE' });
            } catch (e) {
                console.error('서버 데이터 초기화 실패:', e);
                alert('서버 데이터 초기화에 실패했습니다.');
            }
        }
    },

    clearWorkers: async () => {
        localStorage.removeItem(WORKERS_KEY);
        if (SERVER_CONFIG.useServer) {
            try {
                await fetch(`${SERVER_CONFIG.databaseURL}/workers.json`, { method: 'DELETE' });
            } catch (e) {
                console.error('서버 인원 초기화 실패:', e);
                alert('서버 인원 정보 초기화에 실패했습니다.');
            }
        }
    },

    getPassword: () => localStorage.getItem('admin_password') || '1234',
    savePassword: (pw) => {
        localStorage.setItem('admin_password', pw);
        AttendanceDB.saveSettingsToServer();
    },

    getAppTitle: () => localStorage.getItem('app_title') || '프리미엄 근태 관리',
    saveAppTitle: (title) => {
        const value = title || '프리미엄 근태 관리';
        localStorage.setItem('app_title', value);
        AttendanceDB.saveSettingsToServer();
    },

    getAppLogo: () => localStorage.getItem('app_logo') || null,
    saveAppLogo: (logoData) => {
        localStorage.setItem('app_logo', logoData || '');
        AttendanceDB.saveSettingsToServer();
    },

    getAutoLogoutTime: () => parseInt(localStorage.getItem('auto_logout_time')) || 10,
    saveAutoLogoutTime: (minutes) => {
        localStorage.setItem('auto_logout_time', minutes);
        AttendanceDB.saveSettingsToServer();
    },

    getDeadline: () => localStorage.getItem('submission_deadline') || '매월 5일',
    saveDeadline: (deadline) => {
        localStorage.setItem('submission_deadline', deadline);
        AttendanceDB.saveSettingsToServer();
    },

    saveSettingsToServer: async () => {
        if (!SERVER_CONFIG.useServer || !SERVER_CONFIG.databaseURL) return;
        const settings = {
            admin_password: AttendanceDB.getPassword(),
            app_title: AttendanceDB.getAppTitle(),
            app_logo: AttendanceDB.getAppLogo(),
            auto_logout_time: AttendanceDB.getAutoLogoutTime(),
            submission_deadline: AttendanceDB.getDeadline()
        };
        try {
            await fetch(`${SERVER_CONFIG.databaseURL}/settings.json`, {
                method: 'PUT',
                body: JSON.stringify(settings)
            });
        } catch (e) {
            console.error('설정 서버 저장 실패:', e);
        }
    },

    syncSettingsWithServer: async () => {
        if (!SERVER_CONFIG.useServer || !SERVER_CONFIG.databaseURL) return;
        try {
            const response = await fetch(`${SERVER_CONFIG.databaseURL}/settings.json`);
            const s = await response.json();
            if (s) {
                if (s.admin_password) localStorage.setItem('admin_password', s.admin_password);
                if (s.app_title) localStorage.setItem('app_title', s.app_title);
                if (s.app_logo) localStorage.setItem('app_logo', s.app_logo);
                if (s.auto_logout_time) localStorage.setItem('auto_logout_time', s.auto_logout_time);
                if (s.submission_deadline) localStorage.setItem('submission_deadline', s.submission_deadline);
            }
        } catch (e) {
            console.error('설정 서버 동기화 실패:', e);
        }
    },

    getStats: () => {
        const data = AttendanceDB.getAll();
        const today = new Date().toISOString().split('T')[0];
        return {
            total: data.length,
            today: data.filter(d => d.date === today).length,
            uniqueWorkers: new Set(data.map(d => d.name)).size
        };
    }
};

const HolidayUtil = {
    // 양력 고정 휴일
    fixedHolidays: {
        '01-01': '신정',
        '03-01': '삼일절',
        '05-05': '어린이날',
        '06-06': '현충일',
        '08-15': '광복절',
        '10-03': '개천절',
        '10-09': '한글날',
        '12-25': '성탄절'
    },

    // 음력 및 변동 휴일
    dynamicHolidays: {
        // 2025년
        '2025-01-28': '설날', '2025-01-29': '설날', '2025-01-30': '설날',
        '2025-03-03': '대체공휴일',
        '2025-05-06': '대체공휴일',
        '2025-10-05': '추석', '2025-10-06': '추석', '2025-10-07': '추석', '2025-10-08': '대체공휴일',

        // 2026년
        '2026-02-16': '설날', '2026-02-17': '설날', '2026-02-18': '설날',
        '2026-03-02': '대체공휴일',
        '2026-05-24': '부처님오신날', '2026-05-25': '대체공휴일',
        '2026-08-17': '대체공휴일',
        '2026-09-24': '추석', '2026-09-25': '추석', '2026-09-26': '추석',
        '2026-10-05': '대체공휴일',

        // 2027년
        '2027-02-06': '설날', '2027-02-07': '설날', '2027-02-08': '설날', '2027-02-09': '대체공휴일',
        '2027-05-13': '부처님오신날',
        '2027-08-16': '대체공휴일',
        '2027-09-14': '추석', '2027-09-15': '추석', '2027-09-16': '추석',
        '2027-10-04': '대체공휴일'
    },

    // 사용자 정의 휴일 { 'YYYY-MM-DD': '명칭' }
    customHolidays: {},

    init: async () => {
        // 1. 로컬 로드
        let local = JSON.parse(localStorage.getItem('custom_holidays') || '{}');

        // [마이그레이션] 기존 배열 데이터(Set -> Array)가 있다면 객체로 변환
        if (Array.isArray(local)) {
            const converted = {};
            local.forEach(d => converted[d] = '지정 휴일');
            local = converted;
            localStorage.setItem('custom_holidays', JSON.stringify(local));
        }
        HolidayUtil.customHolidays = local;

        // 2. 서버 로드 (병합)
        if (SERVER_CONFIG.useServer) {
            try {
                const res = await fetch(`${SERVER_CONFIG.databaseURL}/holidays.json`);
                const serverData = await res.json();
                if (serverData) {
                    // 서버 데이터 병합 (서버 데이터 우선 혹은 병합 전략)
                    // 여기서는 서버 데이터가 배열일 수도 있으므로 체크 필요
                    let incoming = serverData;
                    if (Array.isArray(incoming)) {
                        const converted = {};
                        incoming.forEach(d => converted[d] = '지정 휴일');
                        incoming = converted;
                    }

                    // 병합 (로컬 + 서버)
                    HolidayUtil.customHolidays = { ...HolidayUtil.customHolidays, ...incoming };

                    // 로컬 업데이트
                    localStorage.setItem('custom_holidays', JSON.stringify(HolidayUtil.customHolidays));
                }
            } catch (e) {
                console.error('휴일 데이터 동기화 실패', e);
            }
        }
    },

    saveCustom: async () => {
        const data = HolidayUtil.customHolidays; // Object
        localStorage.setItem('custom_holidays', JSON.stringify(data));

        if (SERVER_CONFIG.useServer) {
            try {
                // 객체 형태 그대로 저장
                await fetch(`${SERVER_CONFIG.databaseURL}/holidays.json`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            } catch (e) {
                console.error('휴일 서버 저장 실패', e);
            }
        }
    },

    // 휴일 설정 (추가/수정/삭제)
    setCustom: async (dateStr, name) => {
        if (!name) {
            // 이름 없으면 삭제
            delete HolidayUtil.customHolidays[dateStr];
        } else {
            // 추가 또는 수정
            HolidayUtil.customHolidays[dateStr] = name;
        }
        await HolidayUtil.saveCustom();
    },

    getHolidayName: (dateStr) => {
        // 1. 변동/음력 (설날, 추석 등)
        if (HolidayUtil.dynamicHolidays[dateStr]) return HolidayUtil.dynamicHolidays[dateStr];
        // 2. 고정 (신정, 삼일절 등)
        const md = dateStr.substring(5);
        if (HolidayUtil.fixedHolidays[md]) return HolidayUtil.fixedHolidays[md];
        // 3. 커스텀 (사용자 지정)
        if (HolidayUtil.customHolidays[dateStr]) return HolidayUtil.customHolidays[dateStr];

        return null;
    },

    isHoliday: (dateStr) => {
        return !!HolidayUtil.getHolidayName(dateStr);
    }
};

// 앱 시작 시 휴일 데이터 로드
HolidayUtil.init();
