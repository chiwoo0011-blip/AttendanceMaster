<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드 - 근태관리 시스템</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="app.js"></script>
    <style>
        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            color: var(--text-muted);
            text-decoration: none;
            cursor: pointer;
            border-radius: 0.5rem;
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* Login Screen Styles */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 3rem;
            text-align: center;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .brand-logo {
            width: 64px;
            height: 64px;
            background: var(--primary);
            color: white;
            border-radius: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--primary), #818cf8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-input-group {
            margin-top: 2rem;
            text-align: left;
        }

        .login-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
            margin-bottom: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            color: #1f2937;
            font-family: sans-serif;
        }

        .login-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #adminContent {
            display: none;
        }

        .logo-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        #mainLogoArea img,
        #loginLogoArea img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="glass login-card">
            <div class="brand-logo" id="loginLogoArea">
                <i data-lucide="shield-check" style="width: 32px; height: 32px;"></i>
            </div>
            <div class="brand-name" id="loginAppTitle"></div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">관리자 인증</p>

            <div class="login-input-group">
                <input type="password" id="adminPasswordInput" class="login-input" placeholder="비밀번호를 입력하세요"
                    autocomplete="current-password" onkeyup="if(event.key==='Enter') checkAdminLogin()">
                <button class="btn btn-primary" onclick="checkAdminLogin()" style="width: 100%; padding: 1rem;">
                    대시보드 접속하기
                </button>
            </div>
            <p id="loginError" style="color: var(--danger); font-size: 0.85rem; margin-top: 1rem; display: none;">비밀번호가
                일치하지 않습니다.</p>
        </div>
    </div>

    <script>
        function checkAdminLogin() {
            const input = document.getElementById('adminPasswordInput').value;
            const currentPassword = AttendanceDB.getPassword();

            if (input === currentPassword) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                refreshAppTitles(); // 제목과 로고 다시 확인
                lucide.createIcons(); // 대시보드 아이콘 로드
                if (typeof renderAggregatedTable === 'function') renderAggregatedTable();

                // 자동 로그아웃 타이머 시작
                resetInactivityTimer();
            } else {
                const error = document.getElementById('loginError');
                error.style.display = 'block';
                // 흔들림 효과 애니메이션 추가 가능
            }
        }

        // 제목 및 로고 업데이트 함수
        function refreshAppTitles() {
            const title = AttendanceDB.getAppTitle();
            const logo = AttendanceDB.getAppLogo();

            const loginTitle = document.getElementById('loginAppTitle');
            const mainTitle = document.getElementById('mainAppTitle');
            if (loginTitle) loginTitle.innerText = title;
            if (mainTitle) mainTitle.innerText = title;
            document.title = `${title} - 관리자 대시보드`;

            // 로고 반영
            const loginLogoArea = document.getElementById('loginLogoArea');
            const mainLogoArea = document.getElementById('mainLogoArea');
            const logoHtml = logo ? `<img src="${logo}" class="logo-img">` : `<i data-lucide="shield-check" style="width: 32px; height: 32px;"></i>`;
            const mainLogoHtml = logo ? `<img src="${logo}" class="logo-img" style="width:48px; height:48px; border-radius:0.5rem;">` : '';

            if (loginLogoArea) loginLogoArea.innerHTML = logoHtml;
            if (mainLogoArea) mainLogoArea.innerHTML = mainLogoHtml;

            lucide.createIcons();
        }

        // 초기 로드 시 실행
        window.addEventListener('DOMContentLoaded', async () => {
            if (SERVER_CONFIG.useServer) {
                await AttendanceDB.syncSettingsWithServer();
            }
            refreshAppTitles();
        });
    </script>
    <div id="adminContent">
        <div class="container no-print">
            <header class="fade-in"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div id="mainLogoArea"></div>
                    <div>
                        <h1 id="mainAppTitle" style="margin-bottom:0.2rem;">프리미엄 근태 관리</h1>
                        <p style="color: var(--text-muted);">통계, 인원 관리 및 일괄 리포트 출력</p>
                    </div>
                </div>
            </header>

            <nav class="nav-tabs fade-in">
                <div class="nav-link active" onclick="showSection('aggView', this)">월간 집계</div>
                <div class="nav-link" onclick="showSection('annualView', this)">연간 집계</div>
                <div class="nav-link" onclick="showSection('workerView', this)">인원 관리</div>
                <div class="nav-link" onclick="showSection('holidayView', this)">휴일 관리</div>
                <div class="nav-link" onclick="showSection('settingsView', this)" style="margin-left:auto;">
                    <i data-lucide="settings" style="width:16px;"></i> 설정
                </div>
            </nav>

            <!-- Aggregated View Section -->
            <div id="aggView" class="view-section active fade-in">
                <div class="stats-grid">
                    <div class="glass stat-card">
                        <div class="stat-value" id="activeWorkers">0</div>
                        <div class="stat-label">이번 달 근무 인원</div>
                    </div>
                    <div class="glass stat-card">
                        <div class="stat-value" id="totalRecords">0</div>
                        <div class="stat-label">누적 전체 기록</div>
                    </div>
                </div>

                <div class="glass"
                    style="padding: 1.5rem; margin-bottom: 2rem; display: flex; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 2;">
                        <label>이름 검색</label>
                        <input type="text" id="filterName" placeholder="성명을 입력하세요" oninput="renderAggregatedTable()">
                    </div>
                    <div style="flex: 1;">
                        <label>조회 월 선택</label>
                        <input type="month" id="filterMonth" onchange="renderAggregatedTable()">
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="syncBtn" class="btn btn-secondary" onclick="syncServer()"
                            style="color: var(--success);">
                            <i data-lucide="refresh-cw"></i> 서버 동기화
                        </button>
                        <button class="btn btn-secondary" onclick="importFromMessage()" style="color: var(--primary);">
                            <i data-lucide="import"></i> 붙여넣기 집계
                        </button>
                        <button class="btn btn-primary" onclick="printAll()">
                            <i data-lucide="printer"></i> 모두 출력
                        </button>
                    </div>
                </div>

                <div class="glass" style="padding: 1.5rem;">
                    <table id="summaryTable">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>성명</th>
                                <th>해당 월</th>
                                <th>총 근무일수</th>
                                <th>최근 전송일</th>
                                <th>리포트</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Annual Summary Section -->
            <div id="annualView" class="view-section fade-in">
                <div class="glass"
                    style="padding: 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="flex: 1; max-width: 200px;">
                        <label>조회 연도</label>
                        <select id="annualYearSelect" onchange="renderAnnualTable()" class="btn btn-secondary"
                            style="width:100%; text-align:left;">
                            <option value="2025">2025년</option>
                            <option value="2026">2026년</option>
                            <option value="2027">2027년</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="printAnnualReport()">
                        <i data-lucide="printer"></i> 연간 리포트 인쇄
                    </button>
                </div>
                <div class="glass" style="padding: 1.5rem; overflow-x: auto;">
                    <table id="annualTable" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>성명</th>
                                <th>1월</th>
                                <th>2월</th>
                                <th>3월</th>
                                <th>4월</th>
                                <th>5월</th>
                                <th>6월</th>
                                <th>7월</th>
                                <th>8월</th>
                                <th>9월</th>
                                <th>10월</th>
                                <th>11월</th>
                                <th>12월</th>
                                <th style="background:#f0f7ff;">합계</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Worker Management Section -->
            <div id="workerView" class="view-section fade-in">
                <div class="glass"
                    style="padding: 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                    <h2>등록된 인원 목록</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="copyAttendanceLink()">
                                <i data-lucide="copy"></i> 출근부 작성
                            </button>
                            <button class="btn btn-secondary" onclick="openWorkerModal()">
                                <i data-lucide="user-plus"></i> 새 인원 등록
                            </button>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="triggerExcelUpload()">
                                <i data-lucide="upload"></i> Excel 업로드
                            </button>
                            <input type="file" id="workerExcelInput" style="display: none;" accept=".xlsx, .xls"
                                onchange="handleExcelUpload(event)">
                            <button class="btn btn-secondary" onclick="exportWorkersExcel()">
                                <i data-lucide="file-spreadsheet"></i> 명단 Excel
                            </button>
                        </div>
                    </div>
                </div>
                <div class="glass" style="padding: 1.5rem;">
                    <table id="workerTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllWorkers" onclick="toggleAllWorkers(this)"></th>
                                <th>이름</th>
                                <th>전화번호</th>
                                <th>구분</th>
                                <th>주소</th>
                                <th>비고</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Holiday Management Section -->
            <div id="holidayView" class="view-section fade-in">
                <div class="glass" style="padding: 1.5rem; margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h2>휴일 관리</h2>
                            <p style="color: var(--text-muted);">날짜를 클릭하여 휴일 또는 학교 재량 휴업일을 지정/해제하세요.</p>
                            <p style="font-size: 0.8rem; color: var(--danger);">* 빨간색으로 표시된 날짜는 휴일로 처리됩니다.</p>
                        </div>
                    </div>
                    <div class="input-group" style="max-width: 300px; margin-bottom: 2rem;">
                        <label>관리할 월 선택</label>
                        <input type="month" id="holidayMonth" onchange="renderHolidayCalendar()">
                    </div>

                    <div class="weekday-row"
                        style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin-bottom: 0.5rem;">
                        <div style="color: var(--danger);">일</div>
                        <div>월</div>
                        <div>화</div>
                        <div>수</div>
                        <div>목</div>
                        <div>금</div>
                        <div style="color: var(--primary);">토</div>
                    </div>
                    <div id="holidayCalendarGrid" class="calendar-grid"></div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsView" class="view-section fade-in">
                <div class="glass" style="padding: 2rem; max-width: 600px; margin: 0 auto;">
                    <h2 style="margin-bottom: 2rem;"><i data-lucide="settings"></i> 시스템 설정</h2>

                    <div style="margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <h3>로고 이미지 설정</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1rem;">로그인 화면과 대시보드 상단에 표시될
                            로고를 변경합니다.</p>
                        <div style="display:flex; align-items:center; gap:1.5rem;">
                            <div id="logoPreview" class="glass"
                                style="width:80px; height:80px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:white;">
                                <i data-lucide="image" style="color:#ccc;"></i>
                            </div>
                            <div style="flex:1;">
                                <input type="file" id="logoInput" accept="image/*" style="display:none;"
                                    onchange="updateAppLogo(this)">
                                <button class="btn btn-secondary"
                                    onclick="document.getElementById('logoInput').click()">이미지 선택</button>
                                <button class="btn btn-secondary" onclick="resetAppLogo()"
                                    style="color:var(--danger);">초기화</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <h3>앱 이름 설정</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1rem;">대시보드 상단 및 로그인 화면에 표시될
                            이름을 수정합니다.</p>
                        <div style="display:flex; gap:0.5rem; align-items:stretch;">
                            <input type="text" id="appTitleInput" placeholder="예: 우리회사 근태관리" class="btn btn-secondary"
                                style="flex:1; text-align:left; cursor:text; color: var(--primary); font-size: 1.2rem; font-weight: 800; border: 2px solid var(--primary); background: #f8fafc; padding: 0.8rem 1rem;">
                            <button class="btn btn-primary" onclick="updateAppTitle()" style="min-width:120px;">이름
                                변경</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <h3>자동 로그아웃 설정</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1rem;">장시간 활동이 없을 경우 자동으로
                            초기화면으로 돌아갑니다. (0 입력 시 비활성화)</p>
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <input type="number" id="autoLogoutInput" placeholder="10" class="btn btn-secondary"
                                style="width:120px; text-align:center; cursor:text; color: var(--primary); font-size: 1.5rem; font-weight: 900; border: 2px solid var(--primary); background: #f8fafc;">
                            <span style="font-weight:600;">분 후 로그아웃</span>
                            <button class="btn btn-primary" onclick="updateAutoLogoutTime()"
                                style="margin-left:auto;">설정 저장</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <h3>관리자 비밀번호 변경</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1rem;">대시보드 접속 시 사용하는 비밀번호를
                            수정합니다.</p>
                        <div style="display:flex; gap:0.5rem; align-items:stretch;">
                            <input type="password" id="newPassword" placeholder="새 비밀번호 입력" class="btn btn-secondary"
                                autocomplete="off"
                                style="flex:1; text-align:left; cursor:text; color: var(--primary); font-size: 1.2rem; font-weight: 800; border: 2px solid var(--primary); background: #f8fafc; padding: 0.8rem 1rem;">
                            <button class="btn btn-primary" onclick="updatePassword()" style="min-width:120px;">변경
                                저장</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <h3>출근부 제출 기한 설정</h3>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:1rem;">직원들에게 보낼 안내 문구에 포함될 제출
                            기한을 설정합니다.</p>
                        <div style="display:flex; gap:0.5rem; align-items:stretch;">
                            <input type="text" id="deadlineInput" placeholder="예: 매월 5일" class="btn btn-secondary"
                                style="flex:1; text-align:left; cursor:text; color: var(--primary); font-size: 1.2rem; font-weight: 800; border: 2px solid var(--primary); background: #f8fafc; padding: 0.8rem 1rem;">
                            <button class="btn btn-primary" onclick="updateDeadline()" style="min-width:120px;">기한
                                설정</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h3>데이터 초기화</h3>
                        <p style="color:var(--danger); font-size:0.9rem; margin-bottom:1.5rem;">⚠️ 초기화된 데이터는 복구할 수 없습니다.
                            신중하게 선택하세요.</p>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div class="glass" style="padding:1.5rem; text-align:center; border:1px solid #fee2e2;">
                                <h4 style="margin-bottom:0.5rem;">출근 기록 초기화</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">전체 출근/사인 데이터를
                                    삭제합니다.</p>
                                <button class="btn btn-secondary" onclick="clearAllRecords()"
                                    style="color:var(--danger); width:100%;">기본 기록 삭제</button>
                            </div>
                            <div class="glass" style="padding:1.5rem; text-align:center; border:1px solid #fee2e2;">
                                <h4 style="margin-bottom:0.5rem;">인원 명단 초기화</h4>
                                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">등록된 모든 직원 명단을
                                    삭제합니다.</p>
                                <button class="btn btn-secondary" onclick="clearAllWorkersData()"
                                    style="color:var(--danger); width:100%;">명단 전체 삭제</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Worker Add Modal -->
        <div id="workerModal" class="modal-overlay" onclick="closeWorkerModal(event)">
            <div class="glass modal-content" onclick="event.stopPropagation()">
                <h2 style="margin-bottom: 1.5rem;">인원 등록</h2>
                <form id="workerForm" onsubmit="saveWorker(event)">
                    <input type="hidden" id="wId">
                    <div class="worker-form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="input-group">
                            <label>성명</label>
                            <input type="text" id="wName" required>
                        </div>
                        <div class="input-group">
                            <label>전화번호</label>
                            <input type="text" id="wPhone" placeholder="010-0000-0000">
                        </div>
                        <div class="input-group">
                            <label>구분 (직접입력)</label>
                            <input type="text" id="wType">
                        </div>
                        <div class="input-group full-width">
                            <label>주소</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <input type="text" id="wAddress" placeholder="기본 주소를 입력하세요 (예: 서울시 강남구)">
                                <input type="text" id="wAddressDetail" placeholder="상세 주소를 입력하세요 (동, 호수 등)">
                            </div>
                        </div>
                        <div class="input-group full-width">
                            <label>비고</label>
                            <input type="text" id="wNote">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 2;">등록하기</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;"
                            onclick="closeWorkerModal()">취소</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Auth Modal -->
        <div id="settingsAuthModal" class="modal-overlay">
            <div class="glass modal-content" style="max-width: 350px; text-align: center; padding: 2rem;">
                <div class="brand-logo" style="width: 48px; height: 48px; margin-bottom: 1rem;">
                    <i data-lucide="lock" style="width: 24px; height: 24px;"></i>
                </div>
                <h3>보안 인증</h3>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem;">설정 진입을 위해 비밀번호를 입력하세요.
                </p>
                <div class="input-group">
                    <input type="password" id="settingsAuthPw" class="login-input" placeholder="비밀번호 입력"
                        autocomplete="new-password"
                        style="margin-bottom: 1rem; background: white !important; color: black !important; font-weight: bold;"
                        onkeyup="if(event.key==='Enter') checkSettingsAuth()">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="checkSettingsAuth()" style="flex: 2;">확인</button>
                    <button class="btn btn-secondary" onclick="closeSettingsAuth()" style="flex: 1;">취소</button>
                </div>
            </div>
        </div>

        <!-- Hidden Print Container -->
        <div id="printSection" class="print-only"></div>

        <script src="app.js"></script>
        <script>
            lucide.createIcons();

            const monthInput = document.getElementById('filterMonth');
            const holidayMonthInput = document.getElementById('holidayMonth');
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            monthInput.value = currentMonthStr;
            holidayMonthInput.value = currentMonthStr;

            let pendingSection = null;
            let pendingNavItem = null;

            function showSection(id, el) {
                // 설정 탭 진입 시 보안 확인 (커스텀 모달)
                if (id === 'settingsView') {
                    pendingSection = id;
                    pendingNavItem = el;
                    document.getElementById('settingsAuthModal').style.display = 'flex';
                    document.getElementById('settingsAuthPw').value = '';
                    document.getElementById('settingsAuthPw').focus();
                    return;
                }
                switchTab(id, el);
            }

            function switchTab(id, el) {
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if (el) el.classList.add('active');

                if (id === 'aggView') renderAggregatedTable();
                if (id === 'workerView') renderWorkerTable();
                if (id === 'holidayView') renderHolidayCalendar();
                if (id === 'annualView') renderAnnualTable();
                if (id === 'settingsView') {
                    document.getElementById('autoLogoutInput').value = AttendanceDB.getAutoLogoutTime();
                    document.getElementById('deadlineInput').value = AttendanceDB.getDeadline();
                }
            }

            // --- 자동 로그아웃 로직 ---
            let inactivityTimer;
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                const minutes = AttendanceDB.getAutoLogoutTime();
                if (minutes > 0 && document.getElementById('adminContent').style.display === 'block') {
                    inactivityTimer = setTimeout(logoutAdmin, minutes * 60 * 1000);
                }
            }

            function logoutAdmin() {
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminPasswordInput').value = '';
                alert('장시간 활동이 없어 보안을 위해 자동 로그아웃되었습니다.');
            }

            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(name => {
                document.addEventListener(name, resetInactivityTimer, true);
            });
            // -----------------------

            function checkSettingsAuth() {
                const input = document.getElementById('settingsAuthPw').value;
                if (input === AttendanceDB.getPassword()) {
                    const sectionId = pendingSection;
                    const navItem = pendingNavItem;
                    closeSettingsAuth();
                    if (sectionId) switchTab(sectionId, navItem);
                } else {
                    alert('비밀번호가 일치하지 않습니다.');
                    document.getElementById('settingsAuthPw').value = '';
                    document.getElementById('settingsAuthPw').focus();
                }
            }

            function closeSettingsAuth() {
                document.getElementById('settingsAuthModal').style.display = 'none';
                pendingSection = null;
                pendingNavItem = null;
            }

            async function toggleHoliday(dateStr) {
                const currentName = HolidayUtil.getHolidayName(dateStr);
                const isCustom = HolidayUtil.customHolidays[dateStr];
                if (currentName) {
                    if (!isCustom) {
                        alert(`'${currentName}'은(는) 기본 공휴일이라 수정할 수 없습니다.`);
                        return;
                    }
                    if (confirm(`'${currentName}'을(를) 휴일 목록에서 삭제하시겠습니까?`)) {
                        await HolidayUtil.setCustom(dateStr, null);
                    }
                } else {
                    const name = prompt('휴일 이름을 입력하세요 (예: 개교기념일, 재량휴업일)', '학교재량휴업일');
                    if (name) await HolidayUtil.setCustom(dateStr, name);
                }
                renderHolidayCalendar();
            }

            function renderHolidayCalendar() {
                const [year, month] = holidayMonthInput.value.split('-').map(Number);
                const firstDay = new Date(year, month - 1, 1).getDay();
                const daysInMonth = new Date(year, month, 0).getDate();
                const grid = document.getElementById('holidayCalendarGrid');
                grid.innerHTML = '';
                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    empty.className = 'calendar-day disabled';
                    grid.appendChild(empty);
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const day = document.createElement('div');
                    day.className = 'calendar-day';
                    day.innerHTML = `<span>${i}</span>`;
                    const dateStr = `${holidayMonthInput.value}-${String(i).padStart(2, '0')}`;
                    const holidayName = HolidayUtil.getHolidayName(dateStr);
                    if (holidayName) {
                        day.classList.add('holiday');
                        day.classList.add('selected');
                        day.innerHTML += `<div class="holiday-name">${holidayName}</div>`;
                    }
                    day.onclick = () => toggleHoliday(dateStr);
                    grid.appendChild(day);
                }
            }

            function renderAggregatedTable() {
                const data = AttendanceDB.getAll();
                const filterName = document.getElementById('filterName').value.toLowerCase();
                const filterMonth = monthInput.value;
                const groups = {};
                data.forEach(item => {
                    const itemMonth = item.date.substring(0, 7);
                    if (itemMonth !== filterMonth) return;
                    if (filterName && !item.name.toLowerCase().includes(filterName)) return;
                    if (!groups[item.name]) groups[item.name] = { name: item.name, month: itemMonth, days: new Set(), lastUpdate: item.timestamp };
                    groups[item.name].days.add(item.date);
                    if (new Date(item.timestamp) > new Date(groups[item.name].lastUpdate)) groups[item.name].lastUpdate = item.timestamp;
                });
                const tbody = document.querySelector('#summaryTable tbody');
                tbody.innerHTML = '';
                const groupArray = Object.values(groups);
                document.getElementById('activeWorkers').innerText = groupArray.length;
                document.getElementById('totalRecords').innerText = data.length;
                groupArray.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));
                groupArray.forEach((group, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${groupArray.length - index}</td>
                    <td style="font-weight:600;">${group.name}</td>
                    <td>${group.month}</td>
                    <td><span class="badge badge-success">${group.days.size}일</span></td>
                    <td style="font-size: 0.8rem;">${new Date(group.lastUpdate).toLocaleString()}</td>
                    <td><button class="btn btn-secondary btn-sm" onclick="printIndividual('${group.name}', '${group.month}')">출력</button></td>
                `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            }

            function renderAnnualTable() {
                const year = document.getElementById('annualYearSelect').value;
                const data = AttendanceDB.getAll();
                const workers = AttendanceDB.getWorkers();
                const tbody = document.querySelector('#annualTable tbody');
                tbody.innerHTML = '';
                const nameSet = new Set(workers.map(w => w.name));
                data.forEach(r => nameSet.add(r.name));
                Array.from(nameSet).sort().forEach(name => {
                    const tr = document.createElement('tr');
                    let html = `<td style="font-weight:600;">${name}</td>`;
                    let total = 0;
                    for (let m = 1; m <= 12; m++) {
                        const mStr = `${year}-${String(m).padStart(2, '0')}`;
                        const count = data.filter(r => r.name === name && r.date.startsWith(mStr)).length;
                        html += `<td>${count > 0 ? count + '일' : '-'}</td>`;
                        total += count;
                    }
                    html += `<td style="font-weight:bold; color:var(--primary); background:#f0f7ff;">${total}일</td>`;
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
            }

            function renderWorkerTable() {
                const workers = AttendanceDB.getWorkers();
                const tbody = document.querySelector('#workerTable tbody');
                tbody.innerHTML = '';
                workers.forEach(w => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td><input type="checkbox" class="worker-check" data-name="${w.name}" data-phone="${w.phone}"></td>
                    <td style="font-weight:600;">${w.name}</td>
                    <td>${w.phone}</td>
                    <td>${w.type}</td>
                    <td>${w.address}</td>
                    <td>${w.note}</td>
                    <td>
                        <div style="display:flex; gap:0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="editWorker('${w.id}')">수정</button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteWorker(${w.id})">삭제</button>
                        </div>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            }

            function toggleAllWorkers(master) { document.querySelectorAll('.worker-check').forEach(cb => cb.checked = master.checked); }

            async function copyAttendanceLink() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const date = now.getDate();
                const deadline = AttendanceDB.getDeadline();

                const msg = `[근태관리 안내]\n\n${year}년 ${month}월분 출근부 작성을 부탁드립니다.\n\n- 보내는 일자: ${year}.${month}.${date}\n- 제출 기한: ${deadline}까지\n\n아래 주소로 접속하여 본인 성명 입력 후 서명해 주세요.\n${getWorkerUrl()}`;

                try {
                    await navigator.clipboard.writeText(msg);
                    alert('안내 문구가 복사되었습니다!\n원하는 곳(카톡/문자 등)에 붙여넣기(Ctrl+V) 하세요.');
                } catch (e) {
                    console.error('복사 실패:', e);
                    alert('문구 복사에 실패했습니다. 브라우저 설정을 확인해주세요.');
                }
            }

            function getWorkerUrl() {
                let base = typeof GLOBAL_URL !== 'undefined' && GLOBAL_URL ? GLOBAL_URL : window.location.href.replace('admin.html', '');
                if (!base.endsWith('/')) base += '/';
                return `${base}worker.html`;
            }

            async function requestAttendance(name, phone) {
                const msg = `[근태관리] 출근부 작성을 부탁드립니다.\n접속 주소: ${getWorkerUrl()}`;
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                try {
                    await navigator.clipboard.writeText(msg);
                    if (isMobile) {
                        window.location.href = `sms:${phone}${navigator.userAgent.match(/iPhone/i) ? '&' : '?'}body=${encodeURIComponent(msg)}`;
                    } else {
                        alert(`전체 공용 안내 문구가 복사되었습니다.\n원하는 곳에 붙여넣기(Ctrl+V) 하세요.`);
                    }
                } catch (e) {
                    window.location.href = `sms:${phone}${navigator.userAgent.match(/iPhone/i) ? '&' : '?'}body=${encodeURIComponent(msg)}`;
                }
            }

            async function copyToKakao(name, phone, isBatch = false) {
                const msg = `[근태관리] 출근부 작성을 부탁드립니다.\n\n접속 주소: ${getWorkerUrl()}`;
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                try {
                    await navigator.clipboard.writeText(msg);
                    if (!isBatch) {
                        if (confirm(`안내 문구가 복사되었습니다.\n확인을 누르면 카톡이 실행됩니다. 원하는 채팅방에 붙여넣기(Ctrl+V) 하세요.`)) {
                            window.location.href = 'kakaotalk://';
                        }
                    } else {
                        if (isMobile) window.location.href = 'kakaotalk://';
                    }
                } catch (e) {
                    prompt('복사 실패. 아래 문구를 직접 복사하세요:', msg);
                }
            }

            function closeWorkerModal(e) {
                if (e && e.target !== e.currentTarget) return;
                document.getElementById('workerModal').style.display = 'none';
            }

            function openWorkerModal(worker = null) {
                const m = document.getElementById('workerModal');
                document.getElementById('workerForm').reset();
                document.getElementById('wId').value = worker ? worker.id : '';
                if (worker) {
                    document.getElementById('wName').value = worker.name;
                    document.getElementById('wPhone').value = worker.phone;
                    document.getElementById('wType').value = worker.type;
                    document.getElementById('wAddress').value = worker.address;
                    document.getElementById('wAddressDetail').value = worker.addressDetail; // Added this line
                    document.getElementById('wNote').value = worker.note;
                }
                m.style.display = 'flex';
            }

            function editWorker(id) {
                const w = AttendanceDB.getWorkers().find(x => x.id == id);
                if (w) openWorkerModal(w);
            }

            async function saveWorker(e) {
                e.preventDefault();
                const id = document.getElementById('wId').value;
                const w = { name: document.getElementById('wName').value, phone: document.getElementById('wPhone').value, type: document.getElementById('wType').value, address: document.getElementById('wAddress').value, addressDetail: document.getElementById('wAddressDetail').value, note: document.getElementById('wNote').value }; // Modified this line
                if (id) await AttendanceDB.updateWorker({ ...w, id }); else await AttendanceDB.saveWorker(w);
                document.getElementById('workerModal').style.display = 'none';
                renderWorkerTable();
            }

            function deleteWorker(id) { if (confirm('삭제할까요?')) { AttendanceDB.deleteWorker(id); renderWorkerTable(); } }

            function updatePassword() {
                const pwInput = document.getElementById('newPassword');
                const pw = pwInput.value;
                if (pw.length < 4) return alert('4자리 이상 입력하세요.');
                if (confirm('비밀번호를 변경할까요?')) {
                    AttendanceDB.savePassword(pw);
                    alert('변경되었습니다.');
                    pwInput.value = ''; // 입력창 비우기
                }
            }

            function updateAppTitle() {
                const titleInput = document.getElementById('appTitleInput');
                const title = titleInput.value.trim();
                if (!title) return alert('변경할 이름을 입력하세요.');
                if (confirm(`앱 이름을 "${title}"(으)로 변경할까요?`)) {
                    AttendanceDB.saveAppTitle(title);
                    refreshAppTitles();
                    alert('변경되었습니다.');
                    titleInput.value = '';
                }
            }

            function updateAppLogo(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        if (confirm('선택한 이미지를 로고로 사용하시겠습니까?')) {
                            AttendanceDB.saveAppLogo(e.target.result);
                            refreshAppTitles();
                            alert('로고가 성공적으로 변경되었습니다.');
                        }
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            function resetAppLogo() {
                if (confirm('로고를 기본 아이콘으로 초기화할까요?')) {
                    AttendanceDB.saveAppLogo(null);
                    refreshAppTitles();
                    alert('초기화되었습니다.');
                }
            }

            function updateAutoLogoutTime() {
                const val = document.getElementById('autoLogoutInput').value;
                const minutes = parseInt(val);
                if (isNaN(minutes) || minutes < 0) return alert('올바른 시간을 입력하세요.');
                AttendanceDB.saveAutoLogoutTime(minutes);
                resetInactivityTimer();
                alert('자동 로그아웃 시간이 설정되었습니다.');
            }

            async function clearAllRecords() { if (confirm('모든 출근 기록을 삭제할까요?')) { await AttendanceDB.clear(); alert('삭제되었습니다.'); renderAggregatedTable(); } }
            async function clearAllWorkersData() { if (confirm('모든 인원 명단을 삭제할까요?')) { await AttendanceDB.clearWorkers(); alert('삭제되었습니다.'); renderWorkerTable(); } }

            function updateDeadline() {
                const val = document.getElementById('deadlineInput').value.trim();
                if (!val) return alert('제출 기한을 입력하세요.');
                AttendanceDB.saveDeadline(val);
                alert('제출 기한이 설정되었습니다.');
            }

            function printAnnualReport() {
                const year = document.getElementById('annualYearSelect').value;
                const win = window.open('', '_blank');
                win.document.write(`<html><head><title>${year}년 연간 집계</title><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:5px;text-align:center;}</style></head><body><h1>${year}년 연간 출근 집계표</h1>${document.getElementById('annualTable').outerHTML}</body></html>`);
                win.document.close(); win.print();
            }

            function generateCalendarHTML(name, month, records) {
                const [y, m] = month.split('-').map(Number);
                const days = new Date(y, m, 0).getDate();
                const first = new Date(y, m - 1, 1).getDay();
                const worker = AttendanceDB.getWorkerByName(name);
                let grid = '';
                ['일', '월', '화', '수', '목', '금', '토'].forEach(d => grid += `<div class="calendar-print-header">${d}</div>`);
                for (let i = 0; i < first; i++) grid += '<div class="calendar-print-day other-month"></div>';
                for (let i = 1; i <= days; i++) {
                    const ds = `${month}-${String(i).padStart(2, '0')}`;
                    const entry = records.find(r => r.date === ds);
                    const holiday = HolidayUtil.getHolidayName(ds);
                    const isWE = new Date(y, m - 1, i).getDay() % 6 === 0;
                    grid += `<div class="calendar-print-day${isWE ? ' weekend' : ''}${holiday ? ' holiday' : ''}"><b>${i}</b>${holiday ? `<div class="holiday-name">${holiday}</div>` : ''}<div style="text-align:center;">${entry ? `<img src="${entry.signature}" class="sig-img"><div style="font-size:8px;">출근</div>` : ''}</div></div>`;
                }
                return `<div class="a4-page"><div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:10px; align-items:flex-end;"><div>성명: <b>${name}</b><br>전화: ${worker ? worker.phone : '-'}</div><h1 style="margin:0;">출근부 (${m}월)</h1><div>기간: <b>${y}.${String(m).padStart(2, '0')}</b><br>${worker ? worker.address : '-'}</div></div><div class="calendar-print">${grid}</div></div>`;
            }

            function printIndividual(name, month) {
                const d = AttendanceDB.getAll().filter(r => r.name === name && r.date.startsWith(month));
                document.getElementById('printSection').innerHTML = generateCalendarHTML(name, month, d);
                window.print();
            }

            function printAll() {
                const d = AttendanceDB.getAll();
                const m = monthInput.value;
                const names = [...new Set(d.filter(r => r.date.startsWith(m)).map(r => r.name))];
                if (names.length === 0) return alert('데이터 없음');
                let html = '';
                names.forEach(n => html += generateCalendarHTML(n, m, d.filter(r => r.name === n && r.date.startsWith(m))));
                document.getElementById('printSection').innerHTML = html;
                window.print();
            }

            async function syncServer() {
                const b = document.getElementById('syncBtn');
                const old = b.innerHTML;
                b.disabled = true; b.innerHTML = '동기화 중...';
                try {
                    await AttendanceDB.syncSettingsWithServer();
                    const w = await AttendanceDB.syncWorkersWithServer();
                    const r = await AttendanceDB.syncWithServer();
                    refreshAppTitles();
                    renderWorkerTable(); renderAggregatedTable();
                } catch (e) { alert('동기화 실패'); }
                finally { b.disabled = false; b.innerHTML = old; lucide.createIcons(); }
            }

            window.addEventListener('load', () => { if (SERVER_CONFIG.useServer) syncServer(); });
            renderAggregatedTable();
        </script>
    </div> <!-- End of #adminContent -->
    <div id="printSection"></div>
</body>

</html>