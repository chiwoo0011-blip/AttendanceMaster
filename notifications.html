<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¼ ê´€ë¦¬ - ê·¼íƒœê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .notification-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .worker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .worker-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .worker-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .worker-card.selected {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .worker-checkbox {
            display: none;
        }

        .worker-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .worker-info {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .select-all-btn {
            margin-bottom: 1rem;
        }

        .message-form {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .selected-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .history-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .history-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .history-recipients {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="notification-container">
        <header class="fade-in">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                <a href="admin.html?tab=workerView" style="color: var(--text-muted); text-decoration: none;">
                    <i data-lucide="arrow-left"></i>
                </a>
                <h1>ì•Œë¦¼ ê´€ë¦¬ <span style="font-size: 0.5em;">v1.0</span></h1>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">ì§ì›ë“¤ì—ê²Œ ê°œë³„ ë˜ëŠ” ê·¸ë£¹ ì•Œë¦¼ì„ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </header>

        <main class="glass fade-in" style="padding: 2rem;">
            <!-- ì§ì› ì„ íƒ ì„¹ì…˜ -->
            <section>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">ìˆ˜ì‹ ì ì„ íƒ <span class="selected-count" id="selectedCount">0ëª…</span></h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-sm" onclick="selectAll()">
                            <i data-lucide="check-square"></i> ì „ì²´ ì„ íƒ
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
                            <i data-lucide="x-square"></i> ì„ íƒ í•´ì œ
                        </button>
                    </div>
                </div>

                <!-- ê²€ìƒ‰ ë°” -->
                <div style="margin-bottom: 1.5rem; position: relative;">
                    <input type="text" id="searchInput"
                        placeholder="ğŸ” ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..."
                        oninput="filterWorkers()"
                        style="width: 100%; padding: 0.75rem 3rem 0.75rem 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    <button onclick="clearSearch()"
                        style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.5rem;">
                        <i data-lucide="x" style="width: 18px;"></i>
                    </button>
                </div>

                <div style="margin-bottom: 0.75rem; color: var(--text-muted); font-size: 0.9rem;">
                    <span id="filterInfo">ì „ì²´ ì¸ì› í‘œì‹œ</span>
                </div>

                <div class="worker-grid" id="workerGrid">
                    <!-- ì§ì› ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </section>

            <!-- ë©”ì‹œì§€ ì‘ì„± ì„¹ì…˜ -->
            <section class="message-form">
                <h2 style="margin-bottom: 1.5rem;">ì•Œë¦¼ ë©”ì‹œì§€ ì‘ì„±</h2>

                <div class="form-group">
                    <label for="notificationTitle">ì œëª©</label>
                    <input type="text" id="notificationTitle" placeholder="ì˜ˆ: ê¸‰ì—¬ ì§€ê¸‰ ì•ˆë‚´" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="notificationBody">ë‚´ìš©</label>
                    <textarea id="notificationBody" placeholder="ì•Œë¦¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="sendNotifications()"
                    style="width: 100%; height: 55px; font-size: 1.1rem; font-weight: 800;">
                    <i data-lucide="send"></i> ì•Œë¦¼ ì „ì†¡
                </button>
            </section>

            <!-- ì „ì†¡ íˆìŠ¤í† ë¦¬ -->
            <section style="margin-top: 3rem;">
                <h2 style="margin-bottom: 1.5rem;">ì „ì†¡ íˆìŠ¤í† ë¦¬</h2>
                <div id="historyList">
                    <p style="color: var(--text-muted); text-align: center; padding: 2rem;">ì „ì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </section>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        lucide.createIcons();

        let selectedWorkers = new Set();
        let notificationHistory = JSON.parse(localStorage.getItem('notification_history') || '[]');

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§ì› ëª©ë¡ ë Œë”ë§
        window.addEventListener('load', async () => {
            if (SERVER_CONFIG.useServer) {
                await AttendanceDB.syncWorkersWithServer();
            }
            renderWorkers();
            renderHistory();
            lucide.createIcons();
        });

        // ì§ì› ëª©ë¡ ë Œë”ë§
        function renderWorkers(filteredWorkers = null) {
            const workers = filteredWorkers || AttendanceDB.getWorkers();
            const grid = document.getElementById('workerGrid');

            if (workers.length === 0) {
                const searchTerm = document.getElementById('searchInput').value.trim();
                if (searchTerm) {
                    grid.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem; grid-column: 1 / -1;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    grid.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem; grid-column: 1 / -1;">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                return;
            }

            grid.innerHTML = workers.map(worker => {
                const isSelected = selectedWorkers.has(worker.name);
                return `
                    <div class="worker-card ${isSelected ? 'selected' : ''}" onclick="toggleWorker('${worker.name}')" id="card-${worker.name}">
                        <div class="worker-name">
                            <i data-lucide="user" style="width: 16px; display: inline;"></i>
                            ${worker.name}
                        </div>
                        <div class="worker-info">${worker.workType || 'ìƒì‹œê·¼ë¬´'}</div>
                        <div class="worker-info" style="font-size: 0.75rem;">${worker.phone || ''}</div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        // ì§ì› ê²€ìƒ‰ í•„í„°ë§
        function filterWorkers() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const allWorkers = AttendanceDB.getWorkers();

            if (!searchTerm) {
                renderWorkers();
                document.getElementById('filterInfo').innerText = `ì „ì²´ ì¸ì› í‘œì‹œ (${allWorkers.length}ëª…)`;
                return;
            }

            const filtered = allWorkers.filter(worker => {
                const nameMatch = worker.name.toLowerCase().includes(searchTerm);
                const phoneMatch = worker.phone && worker.phone.includes(searchTerm);
                return nameMatch || phoneMatch;
            });

            renderWorkers(filtered);
            document.getElementById('filterInfo').innerText = `ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ëª… / ì „ì²´ ${allWorkers.length}ëª…`;
        }

        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterWorkers();
            lucide.createIcons();
        }

        // ì§ì› ì„ íƒ í† ê¸€
        function toggleWorker(name) {
            const card = document.getElementById(`card-${name}`);
            if (selectedWorkers.has(name)) {
                selectedWorkers.delete(name);
                card.classList.remove('selected');
            } else {
                selectedWorkers.add(name);
                card.classList.add('selected');
            }
            updateSelectedCount();
        }

        // ì „ì²´ ì„ íƒ
        function selectAll() {
            const workers = AttendanceDB.getWorkers();
            selectedWorkers.clear();
            workers.forEach(worker => {
                selectedWorkers.add(worker.name);
                const card = document.getElementById(`card-${worker.name}`);
                if (card) card.classList.add('selected');
            });
            updateSelectedCount();
        }

        // ì„ íƒ í•´ì œ
        function clearSelection() {
            selectedWorkers.clear();
            document.querySelectorAll('.worker-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectedCount();
        }

        // ì„ íƒëœ ì§ì› ìˆ˜ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            document.getElementById('selectedCount').innerText = `${selectedWorkers.size}ëª…`;
        }

        // ì•Œë¦¼ ì „ì†¡
        async function sendNotifications() {
            const title = document.getElementById('notificationTitle').value.trim();
            const body = document.getElementById('notificationBody').value.trim();

            if (selectedWorkers.size === 0) {
                AudioUtil.playError();
                return alert('ìˆ˜ì‹ ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }

            if (!title) {
                AudioUtil.playError();
                return alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            if (!body) {
                AudioUtil.playError();
                return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            if (!confirm(`${selectedWorkers.size}ëª…ì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const notification = {
                title: title,
                body: body
            };

            try {
                // Firebaseì— ì•Œë¦¼ ì €ì¥
                for (const workerName of selectedWorkers) {
                    await AttendanceDB.saveNotification(workerName, notification);
                }

                // FCM í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡ (Vercel API)
                try {
                    const pushRes = await fetch('/api/send-notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title,
                            body: body,
                            workerNames: Array.from(selectedWorkers)
                        })
                    });
                    const pushResult = await pushRes.json();
                    console.log('FCM push result:', pushResult);
                } catch (pushErr) {
                    console.error('FCM push error:', pushErr);
                }

                // íˆìŠ¤í† ë¦¬ ì €ì¥
                const historyItem = {
                    id: Date.now(),
                    title: title,
                    body: body,
                    recipients: Array.from(selectedWorkers),
                    timestamp: new Date().toISOString()
                };
                notificationHistory.unshift(historyItem);
                if (notificationHistory.length > 50) notificationHistory = notificationHistory.slice(0, 50);
                localStorage.setItem('notification_history', JSON.stringify(notificationHistory));

                AudioUtil.playSuccess();
                alert(`ì•Œë¦¼ì´ ${selectedWorkers.size}ëª…ì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);

                // í¼ ì´ˆê¸°í™”
                document.getElementById('notificationTitle').value = '';
                document.getElementById('notificationBody').value = '';
                clearSelection();
                renderHistory();

            } catch (error) {
                console.error('Notification send error:', error);
                AudioUtil.playError();
                alert('ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íˆìŠ¤í† ë¦¬ ë Œë”ë§
        function renderHistory() {
            const historyList = document.getElementById('historyList');

            if (notificationHistory.length === 0) {
                historyList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">ì „ì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            historyList.innerHTML = notificationHistory.map(item => {
                const date = new Date(item.timestamp);
                const timeStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                return `
                    <div class="history-item">
                        <div class="history-header">
                            <div class="history-title">${item.title}</div>
                            <div class="history-time">${timeStr}</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">${item.body}</div>
                        <div class="history-recipients">
                            <i data-lucide="users" style="width: 14px; display: inline;"></i>
                            ${item.recipients.join(', ')} (${item.recipients.length}ëª…)
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }
    </script>
</body>

</html>